package pl.xt.jokii.websocket;

import java.net.URI;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import pl.xt.jokii.events.WebSocketEvent;
import pl.xt.jokii.events.WebSocketEventListener;

import android.webkit.WebView;
import android.widget.Button;

import com.strumsoft.websocket.phonegap.WebSocket;

public class WebSocketListener extends WebSocket{
//	private Button button;
	private WebSocketEventListener sendListener;
	private WebView appView;
	private List _listeners = new ArrayList();
	
	/**
	 * Add event listener
	 * @param listener
	 */
	public synchronized void addWebSocketEventListener(WebSocketEventListener listener)	{
	_listeners.add(listener);
	}
	
	/**
	 * Remove event listener
	 * @param listener
	 */
	public synchronized void removeWebSocketEventListener(WebSocketEventListener listener)	{
	_listeners.remove(listener);
	}
	  
	
	// call this method when need to notify
	// the event listeners of the particular event
	private synchronized void fireEvent()	{
		WebSocketEvent event = new WebSocketEvent(this);
		Iterator i = _listeners.iterator();
		
		while(i.hasNext())	
		{
			((WebSocketEventListener) i.next()).handleWebSocketEvent(event);
		}
	}
	
	
	/**
	 * Add send event listener
	 * @param listener
	 */
	public synchronized void addSendEventListener(WebSocketEventListener listener)	{
		sendListener = listener;
	}
	
	/**
	 * Remove send event listener
	 * @param listener
	 */
	public synchronized void removeSendEventListener(WebSocketEventListener listener)	{
		sendListener = null;
	}	
	
	private synchronized void fireSendEvent()
	{
		if(sendListener != null)
		{
			sendListener.handleSendEvent();
		}
	}

	protected WebSocketListener(WebView appView, URI uri, Draft draft, String id) {
		super(appView, uri, draft, id);
		
		this.appView = appView;
	}
	
	/**
	 * Temp, test
	 * @param button
	 */
//	public void setButtonView(Button button)
//	{
//		this.button = button;
//	}


	@Override
	public void onOpen() {
		// TODO Auto-generated method stub
		super.onOpen();

	   String customHtml = "<html><body>Conecte</body></html>";
	   this.appView.loadData(customHtml, "text/html", "UTF-8");
	   
	   //this.button.setEnabled(true);
	   
	   fireEvent();
//	   if(this.button != null)
//	   {
//		   this.button.setEnabled(true);
//	   }
	}
	
	@Override
	public void onClose() {
		// TODO Auto-generated method stub
		super.onClose();
	}
	
	public void onMessage(String msg) {
		   String customHtml = "<html><body><h1>"+msg+"</h1></body></html>";
		   this.appView.loadData(customHtml, "text/html", "UTF-8");		
	};
	


}
